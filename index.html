<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rails Magic Quiz ğŸ©</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/ruby.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', system-ui, sans-serif; }

    .choice-btn {
      transition: transform 0.1s ease, box-shadow 0.1s ease;
    }
    .choice-btn:not(:disabled):hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .choice-btn:not(:disabled):active {
      transform: translateY(0);
    }
    .choice-btn:disabled { cursor: not-allowed; }

    .category-card {
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .category-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    }

    pre code.hljs { border-radius: 0.5rem; padding: 1.25rem; font-size: 0.85rem; }

    .fade-in { animation: fadeIn 0.25s ease; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(6px); } to { opacity:1; transform:translateY(0); } }

    .shake { animation: shake 0.35s ease; }
    @keyframes shake {
      0%,100% { transform: translateX(0); }
      20%,60%  { transform: translateX(-5px); }
      40%,80%  { transform: translateX(5px); }
    }

    .correct-glow { box-shadow: 0 0 16px rgba(74,222,128,0.5); }
    .wrong-glow   { box-shadow: 0 0 16px rgba(248,113,113,0.5); }

    /* Progress bar shimmer */
    #progress-bar { background: linear-gradient(90deg, #6366f1, #8b5cf6); }

    /* Score badge pulse on update */
    .score-pulse { animation: scorePulse 0.4s ease; }
    @keyframes scorePulse { 0%,100% { transform:scale(1); } 50% { transform:scale(1.3); color:#fbbf24; } }
  </style>
</head>
<body class="bg-gray-950 text-gray-100 min-h-screen">

<!-- ============================= HOME ============================= -->
<div id="screen-home" class="min-h-screen flex flex-col items-center justify-center p-6">
  <div class="text-center mb-12">
    <div class="text-7xl mb-4">ğŸ©</div>
    <h1 class="text-5xl font-extrabold mb-3 bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent">
      Rails Magic Quiz
    </h1>
    <p class="text-lg text-gray-400">Pure Ruby ã®ã‚³ãƒ¼ãƒ‰ã‚’ Rails ã‚‰ã—ãæ›¸ãæ›ãˆã‚ˆã†ï¼</p>
  </div>

  <div class="w-full max-w-4xl grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
    <div class="category-card bg-indigo-900/60 border border-indigo-700/50 hover:border-indigo-500 rounded-2xl p-6 cursor-pointer text-center"
         data-category="activesupport">
      <div class="text-4xl mb-3">âš¡</div>
      <h2 class="text-xl font-bold mb-1">ActiveSupport</h2>
      <p class="text-indigo-300 text-xs mb-4">blank?, squish, index_by, 1.week...</p>
      <span class="text-xs bg-indigo-800 text-indigo-300 px-3 py-1 rounded-full">13 å•</span>
    </div>
    <div class="category-card bg-emerald-900/60 border border-emerald-700/50 hover:border-emerald-500 rounded-2xl p-6 cursor-pointer text-center"
         data-category="activerecord">
      <div class="text-4xl mb-3">ğŸ—„ï¸</div>
      <h2 class="text-xl font-bold mb-2">Active Record</h2>
      <p class="text-emerald-300 text-xs mb-4">pluck, exists?, find_or_create_by...</p>
      <span class="text-xs bg-emerald-800 text-emerald-300 px-3 py-1 rounded-full">6 å•</span>
    </div>
    <div class="category-card bg-rose-900/60 border border-rose-700/50 hover:border-rose-500 rounded-2xl p-6 cursor-pointer text-center"
         data-category="viewhelper">
      <div class="text-4xl mb-3">ğŸ¨</div>
      <h2 class="text-xl font-bold mb-2">View Helper</h2>
      <p class="text-rose-300 text-xs mb-4">time_ago_in_words, pluralize, cycle...</p>
      <span class="text-xs bg-rose-800 text-rose-300 px-3 py-1 rounded-full">6 å•</span>
    </div>
  </div>

  <button onclick="startAllCategories()"
          class="px-8 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500
                 rounded-full text-lg font-bold transition-all shadow-lg hover:shadow-indigo-500/30">
    å…¨ã‚«ãƒ†ã‚´ãƒªã¾ã¨ã‚ã¦ã‚„ã‚‹ï¼ ğŸš€
  </button>

</div>

<!-- ============================= QUIZ ============================= -->
<div id="screen-quiz" class="hidden min-h-screen flex flex-col">
  <!-- sticky header -->
  <div class="sticky top-0 z-10 bg-gray-950/95 backdrop-blur border-b border-gray-800 px-6 py-3">
    <div class="max-w-3xl mx-auto flex items-center justify-between">
      <button onclick="goHome()" class="text-sm text-gray-500 hover:text-gray-300 transition-colors">
        â† ãƒ›ãƒ¼ãƒ 
      </button>
      <div class="flex items-center gap-4 text-sm">
        <span class="text-gray-400">
          <span id="q-current" class="text-white font-bold">1</span>
          <span class="text-gray-600"> / </span>
          <span id="q-total">6</span>
        </span>
        <span id="q-category-badge" class="hidden sm:inline-block text-xs px-3 py-1 rounded-full bg-gray-800 text-gray-300"></span>
        <div class="flex items-center gap-2 bg-gray-800 px-4 py-1 rounded-full">
          <span class="text-gray-400 text-xs">ã‚¹ã‚³ã‚¢</span>
          <span id="q-score" class="font-bold text-yellow-400 text-lg">0</span>
        </div>
      </div>
    </div>
    <!-- progress bar -->
    <div class="max-w-3xl mx-auto mt-2">
      <div class="w-full bg-gray-800 rounded-full h-1.5">
        <div id="progress-bar" class="h-1.5 rounded-full transition-all duration-500" style="width: 0%"></div>
      </div>
    </div>
  </div>

  <!-- question body -->
  <div class="flex-1 max-w-3xl mx-auto w-full px-4 py-8" id="quiz-body">

    <div class="mb-2 text-sm text-gray-500 font-medium">ã“ã‚“ãªã‚³ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã™ï¼š</div>

    <!-- before code -->
    <div class="mb-6">
      <div class="flex items-center gap-2 mb-2">
        <span class="text-xs bg-red-900/50 text-red-300 border border-red-800/50 px-2 py-0.5 rounded font-mono">Before</span>
        <span class="text-xs text-gray-600">Pure Ruby ã®ã‚³ãƒ¼ãƒ‰</span>
      </div>
      <pre class="rounded-xl overflow-auto"><code id="q-before-code" class="language-ruby"></code></pre>
    </div>

    <div class="text-lg font-semibold mb-4 text-gray-200">âœ¨ Rails ã‚‰ã—ãæ›¸ãã¨ã©ã‚Œï¼Ÿ</div>

    <!-- choices -->
    <div id="q-choices" class="flex flex-col gap-3 mb-6"></div>

    <!-- explanation (shown after answering) -->
    <div id="q-explanation" class="hidden fade-in mt-6 rounded-2xl overflow-hidden border border-gray-700">
      <div class="px-5 py-4 bg-gray-800/80">
        <div class="flex items-center justify-between mb-3">
          <span class="text-green-400 font-bold">ğŸ’¡ è§£èª¬</span>
          <a id="q-doc-link" href="#" target="_blank" rel="noopener noreferrer"
             class="hidden text-xs text-indigo-400 hover:text-indigo-300 flex items-center gap-1 transition-colors">
            ğŸ“– <span id="q-doc-label">ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ</span> â†—
          </a>
        </div>
        <p id="q-explanation-text" class="text-gray-300 text-sm leading-relaxed"></p>
      </div>

      <!-- after code -->
      <div class="px-5 pb-4 bg-gray-800/80">
        <div class="flex items-center gap-2 mb-2">
          <span class="text-xs bg-green-900/50 text-green-300 border border-green-800/50 px-2 py-0.5 rounded font-mono">After</span>
          <span class="text-xs text-gray-600">Rails ã‚‰ã—ã„ã‚³ãƒ¼ãƒ‰</span>
        </div>
        <pre class="rounded-xl overflow-auto"><code id="q-after-code" class="language-ruby"></code></pre>
      </div>

    </div>

    <!-- next button -->
    <div class="mt-6 flex justify-end">
      <button id="btn-next" onclick="nextQuestion()"
              class="hidden px-6 py-2.5 bg-indigo-600 hover:bg-indigo-500 rounded-xl font-bold transition-all
                     shadow-lg hover:shadow-indigo-500/30">
        æ¬¡ã®å•é¡Œ â†’
      </button>
    </div>
  </div>
</div>

<!-- ============================= RESULT ============================= -->
<div id="screen-result" class="hidden min-h-screen flex flex-col items-center justify-center p-6">
  <div class="text-center max-w-lg w-full">
    <div id="result-emoji" class="text-8xl mb-6 fade-in">ğŸ‰</div>
    <h2 class="text-3xl font-extrabold mb-2">ã‚¯ãƒªã‚¢ï¼</h2>

    <div class="flex items-baseline justify-center gap-2 my-6">
      <span id="result-score" class="text-7xl font-extrabold text-yellow-400"></span>
      <span class="text-3xl text-gray-600">/</span>
      <span id="result-total" class="text-3xl text-gray-400"></span>
    </div>

    <p id="result-message" class="text-lg text-gray-300 mb-8"></p>

    <!-- stars -->
    <div id="result-stars" class="text-4xl mb-6"></div>

    <!-- category breakdown -->
    <div id="result-breakdown" class="bg-gray-900 border border-gray-800 rounded-2xl p-6 mb-8 text-left">
      <h3 class="font-bold text-gray-400 text-sm mb-4 uppercase tracking-wider">ã‚«ãƒ†ã‚´ãƒªåˆ¥ã‚¹ã‚³ã‚¢</h3>
      <div id="breakdown-rows"></div>
    </div>

    <div class="flex flex-wrap gap-3 justify-center">
      <button onclick="retryCurrentCategory()"
              class="px-6 py-2.5 bg-indigo-600 hover:bg-indigo-500 rounded-full font-bold transition-all">
        ã‚‚ã†ä¸€åº¦ ğŸ”„
      </button>
      <button onclick="goHome()"
              class="px-6 py-2.5 bg-gray-800 hover:bg-gray-700 rounded-full font-bold transition-all">
        ã‚«ãƒ†ã‚´ãƒªé¸æŠ ğŸ 
      </button>
    </div>
  </div>
</div>

<!-- ============================= SCRIPT ============================= -->
<script type="module">

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ URL ãƒ†ãƒ¼ãƒ–ãƒ«
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DOC_URLS = {
  as1:   { url: 'https://api.rubyonrails.org/classes/Object.html#method-i-blank-3F',     label: 'Rails API â€” Object#blank?' },
  as2:   { url: 'https://api.rubyonrails.org/classes/Object.html#method-i-present-3F',   label: 'Rails API â€” Object#present?' },
  as3:   { url: 'https://api.rubyonrails.org/classes/Object.html#method-i-presence',     label: 'Rails API â€” Object#presence' },
  as4:   { url: 'https://api.rubyonrails.org/classes/Object.html#method-i-in-3F',        label: 'Rails API â€” Object#in?' },
  as5:   { url: 'https://api.rubyonrails.org/classes/Object.html#method-i-try',          label: 'Rails API â€” Object#try' },
  as6:   { url: 'https://api.rubyonrails.org/classes/Object.html#method-i-in-3F',        label: 'Rails API â€” Object#in?' },
  hash5: { url: 'https://api.rubyonrails.org/classes/Hash.html#method-i-deep_merge',     label: 'Rails API â€” Hash#deep_merge' },
  as7:   { url: 'https://api.rubyonrails.org/classes/String.html#method-i-squish',                          label: 'Rails API â€” String#squish' },
  as8:   { url: 'https://api.rubyonrails.org/classes/Array.html#method-c-wrap',                             label: 'Rails API â€” Array.wrap' },
  as9:   { url: 'https://api.rubyonrails.org/classes/Enumerable.html#method-i-index_by',                   label: 'Rails API â€” Enumerable#index_by' },
  as10:  { url: 'https://api.rubyonrails.org/classes/String.html#method-i-truncate',                        label: 'Rails API â€” String#truncate' },
  as11:  { url: 'https://api.rubyonrails.org/classes/Numeric.html#method-i-weeks',                          label: 'Rails API â€” Numeric#weeks' },
  as12:  { url: 'https://api.rubyonrails.org/classes/Enumerable.html#method-i-many-3F',                    label: 'Rails API â€” Enumerable#many?' },
  ar1:   { url: 'https://api.rubyonrails.org/classes/ActiveRecord/Calculations.html#method-i-pluck',        label: 'Rails API â€” ActiveRecord#pluck' },
  ar2:   { url: 'https://api.rubyonrails.org/classes/ActiveRecord/FinderMethods.html#method-i-exists-3F',   label: 'Rails API â€” ActiveRecord#exists?' },
  ar3:   { url: 'https://api.rubyonrails.org/classes/ActiveRecord/Relation.html#method-i-find_or_create_by',label: 'Rails API â€” ActiveRecord#find_or_create_by' },
  ar4:   { url: 'https://api.rubyonrails.org/classes/ActiveRecord/Relation.html#method-i-update_all',       label: 'Rails API â€” ActiveRecord#update_all' },
  ar5:   { url: 'https://api.rubyonrails.org/classes/ActiveRecord/QueryMethods/WhereChain.html#method-i-not',label: 'Rails API â€” where.not' },
  ar6:   { url: 'https://api.rubyonrails.org/classes/ActiveRecord/Batches.html#method-i-find_each',         label: 'Rails API â€” ActiveRecord#find_each' },
  vh1:   { url: 'https://api.rubyonrails.org/classes/ActionView/Helpers/DateHelper.html#method-i-time_ago_in_words',     label: 'Rails API â€” time_ago_in_words' },
  vh2:   { url: 'https://api.rubyonrails.org/classes/ActionView/Helpers/TextHelper.html#method-i-pluralize',             label: 'Rails API â€” pluralize' },
  vh3:   { url: 'https://api.rubyonrails.org/classes/ActionView/Helpers/NumberHelper.html#method-i-number_to_currency',  label: 'Rails API â€” number_to_currency' },
  vh4:   { url: 'https://api.rubyonrails.org/classes/ActionView/Helpers/TagHelper.html#method-i-content_tag',            label: 'Rails API â€” content_tag' },
  vh5:   { url: 'https://api.rubyonrails.org/classes/ActionView/Helpers/NumberHelper.html#method-i-number_to_human_size',label: 'Rails API â€” number_to_human_size' },
  vh6:   { url: 'https://api.rubyonrails.org/classes/ActionView/Helpers/TextHelper.html#method-i-cycle',                 label: 'Rails API â€” cycle' },
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  å•é¡Œãƒ‡ãƒ¼ã‚¿
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ALL_QUESTIONS = {
  activesupport: [
    {
      id: 'as1',
      category: 'ActiveSupport core-ext',
      categoryKey: 'activesupport',
      before: `str.nil? || str == ""`,
      correct: `str.blank?`,
      choices: [
        { text: `str.blank?`, correct: true },
        { text: `str.nil? || str.empty?`, correct: false },
        { text: `str.empty?`, correct: false },
        { text: `str.absent?`, correct: false },
      ],
      explanation: '`blank?` ã¯ ActiveSupport ãŒæä¾›ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã§ã™ã€‚nilãƒ»ç©ºæ–‡å­—ãƒ»ç©ºç™½ã®ã¿ã®æ–‡å­—åˆ—ãƒ»ç©ºé…åˆ—ãƒ»ç©ºãƒãƒƒã‚·ãƒ¥ã™ã¹ã¦ã« true ã‚’è¿”ã—ã¾ã™ã€‚`nil.blank?` ã‚‚å®‰å…¨ã«å‘¼ã³å‡ºã›ã‚‹ãŸã‚ nil ãƒã‚§ãƒƒã‚¯ãŒä¸è¦ã«ãªã‚Šã¾ã™ã€‚',
    },
    {
      id: 'as2',
      category: 'ActiveSupport core-ext',
      categoryKey: 'activesupport',
      before: `!name.nil? && name != ""`,
      correct: `name.present?`,
      choices: [
        { text: `name.present?`, correct: true },
        { text: `!name.blank?`, correct: false },
        { text: `name.exists?`, correct: false },
        { text: `name.filled?`, correct: false },
      ],
      explanation: '`present?` ã¯ `blank?` ã®åå¯¾ã§ã€å€¤ãŒå­˜åœ¨ã™ã‚‹ï¼ˆnil ã§ã‚‚ç©ºã§ã‚‚ãªã„ï¼‰å ´åˆã« true ã‚’è¿”ã—ã¾ã™ã€‚`!name.blank?` ã§ã‚‚åŒã˜ã§ã™ãŒã€`present?` ã®æ–¹ãŒæ„å›³ãŒæ˜ç¢ºã§èª­ã¿ã‚„ã™ã„ã‚³ãƒ¼ãƒ‰ã«ãªã‚Šã¾ã™ã€‚',
    },
    {
      id: 'as3',
      category: 'ActiveSupport core-ext',
      categoryKey: 'activesupport',
      before: `params[:name].present? ? params[:name] : nil`,
      correct: `params[:name].presence`,
      choices: [
        { text: `params[:name].presence`, correct: true },
        { text: `params[:name].or_nil`, correct: false },
        { text: `params[:name].to_presence`, correct: false },
        { text: `params[:name].present_value`, correct: false },
      ],
      explanation: '`presence` ã¯ `present?` ãªã‚‰ self ã‚’ã€`blank?` ãªã‚‰ nil ã‚’è¿”ã—ã¾ã™ã€‚`x.present? ? x : nil` ã¨å®Œå…¨ã«ç­‰ä¾¡ã§ã™ã€‚DB ã®ç©ºæ–‡å­—åˆ—ã‚’ nil ã¨ã—ã¦æ‰±ã†éš›ãªã©ã«ç‰¹ã«æœ‰ç”¨ã§ã™ã€‚',
    },
    {
      id: 'as4',
      category: 'ActiveSupport core-ext',
      categoryKey: 'activesupport',
      before: `[1, 2, 3].include?(x)`,
      correct: `x.in?([1, 2, 3])`,
      choices: [
        { text: `x.in?([1, 2, 3])`, correct: true },
        { text: `[1, 2, 3].has?(x)`, correct: false },
        { text: `x.included_in?([1, 2, 3])`, correct: false },
        { text: `[1, 2, 3].contains?(x)`, correct: false },
      ],
      explanation: '`in?` ã¯ãƒ¬ã‚·ãƒ¼ãƒãƒ¼ãŒã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«å«ã¾ã‚Œã‚‹ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚ã€Œx ãŒ [1,2,3] ã®ä¸­ã«ã‚ã‚‹ï¼Ÿã€ã¨ã„ã†è‹±èªã®è‡ªç„¶ãªèªé †ã§æ›¸ã‘ã‚‹ãŸã‚ã€æ¡ä»¶åˆ†å²ã®ä¸­ã§ã‚ˆã‚Šèª­ã¿ã‚„ã™ã„ã‚³ãƒ¼ãƒ‰ã«ãªã‚Šã¾ã™ã€‚Range ã‚„ Set ãªã© `include?` ã‚’æŒã¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãªã‚‰ã™ã¹ã¦ä½¿ãˆã¾ã™ã€‚',
    },
    {
      id: 'as5',
      category: 'ActiveSupport core-ext',
      categoryKey: 'activesupport',
      before: `user ? user.name : nil`,
      correct: `user.try(:name)`,
      choices: [
        { text: `user.try(:name)`, correct: true },
        { text: `user.safe(:name)`, correct: false },
        { text: `user.try.name`, correct: false },
        { text: `user&.name rescue nil`, correct: false },
      ],
      explanation: '`try` ã¯ nil-safe ãªãƒ¡ã‚½ãƒƒãƒ‰å‘¼ã³å‡ºã—ã§ã™ã€‚ãƒ¬ã‚·ãƒ¼ãƒãƒ¼ãŒ nil ãªã‚‰ nil ã‚’è¿”ã—ã€ãã†ã§ãªã‘ã‚Œã°ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚ãªãŠ Ruby 2.3+ ã§ã¯ `user&.name`ï¼ˆsafe navigation operatorï¼‰ãŒè¨€èªæ©Ÿèƒ½ã¨ã—ã¦å°å…¥ã•ã‚Œã¦ãŠã‚Šã€ç¾åœ¨ã¯ã“ã¡ã‚‰ãŒã‚ˆã‚Šæ¨å¥¨ã•ã‚Œã¾ã™ã€‚',
    },
    {
      id: 'as6',
      category: 'ActiveSupport core-ext',
      categoryKey: 'activesupport',
      before: `role == "admin" || role == "editor" || role == "viewer"`,
      correct: `role.in?(%w[admin editor viewer])`,
      choices: [
        { text: `role.in?(%w[admin editor viewer])`, correct: true },
        { text: `%w[admin editor viewer].any? { |r| r == role }`, correct: false },
        { text: `role.any?(%w[admin editor viewer])`, correct: false },
        { text: `role.one_of?("admin", "editor", "viewer")`, correct: false },
      ],
      explanation: '`in?` ã‚’ä½¿ã†ã¨è¤‡æ•°å€¤ã¨ã®æ¯”è¼ƒãŒä¸€è¡Œã§æ›¸ã‘ã¾ã™ã€‚å€¤ãŒå¢—ãˆã¦ã‚‚é…åˆ—ã«è¿½åŠ ã™ã‚‹ã ã‘ã§ã‚ˆãã€`||` ã§ç¹‹ãæ›¸ãæ–¹ã‚ˆã‚Šæ ¼æ®µã«ä¿å®ˆã—ã‚„ã™ããªã‚Šã¾ã™ã€‚',
    },
    {
      id: 'hash5',
      category: 'ActiveSupport core-ext',
      categoryKey: 'activesupport',
      before: `defaults.merge(config) do |_, old_val, new_val|
  old_val.is_a?(Hash) ? old_val.merge(new_val) : new_val
end`,
      correct: `defaults.deep_merge(config)`,
      choices: [
        { text: `defaults.deep_merge(config)`, correct: true },
        { text: `defaults.merge!(config)`, correct: false },
        { text: `defaults.recursive_merge(config)`, correct: false },
        { text: `defaults.nested_merge(config)`, correct: false },
      ],
      explanation: '`deep_merge` ã¯ ActiveSupport ãŒæä¾›ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã§ã€ãƒã‚¹ãƒˆã—ãŸ Hash ã‚’å†å¸°çš„ã«ãƒãƒ¼ã‚¸ã—ã¾ã™ã€‚é€šå¸¸ã® `merge` ã¯ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã®ã‚­ãƒ¼ã—ã‹ãƒãƒ¼ã‚¸ã—ã¾ã›ã‚“ãŒã€`deep_merge` ã¯ãƒã‚¹ãƒˆå…¨ä½“ã‚’ãƒãƒ¼ã‚¸ã—ã¾ã™ã€‚',
    },
    {
      id: 'as7',
      category: 'ActiveSupport core-ext',
      categoryKey: 'activesupport',
      before: `str.strip.gsub(/\\s+/, ' ')`,
      correct: `str.squish`,
      choices: [
        { text: `str.squish`,              correct: true },
        { text: `str.normalize`,           correct: false },
        { text: `str.compact_whitespace`,  correct: false },
        { text: `str.strip_all`,           correct: false },
      ],
      explanation: '`squish` ã¯å…ˆé ­ãƒ»æœ«å°¾ã®ç©ºç™½ã‚’é™¤å»ã—ã€æ–‡å­—åˆ—å†…ã®é€£ç¶šã—ãŸç©ºç™½ï¼ˆã‚¹ãƒšãƒ¼ã‚¹ãƒ»ã‚¿ãƒ–ãƒ»æ”¹è¡Œã™ã¹ã¦ï¼‰ã‚’1ã¤ã®ã‚¹ãƒšãƒ¼ã‚¹ã«ã¾ã¨ã‚ã¾ã™ã€‚ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›ã®ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ã‚„ã€HTMLã‹ã‚‰æŠ½å‡ºã—ãŸãƒ†ã‚­ã‚¹ãƒˆã®æ­£è¦åŒ–ã«ã‚ˆãä½¿ã‚ã‚Œã¾ã™ã€‚',
    },
    {
      id: 'as8',
      category: 'ActiveSupport core-ext',
      categoryKey: 'activesupport',
      before: `value.is_a?(Array) ? value : (value.nil? ? [] : [value])`,
      correct: `Array.wrap(value)`,
      choices: [
        { text: `Array.wrap(value)`,  correct: true },
        { text: `Array(value)`,       correct: false },
        { text: `[value].flatten`,    correct: false },
        { text: `value.to_a`,         correct: false },
      ],
      explanation: '`Array.wrap` ã¯å€¤ã‚’å®‰å…¨ã«é…åˆ—ã«å¤‰æ›ã—ã¾ã™ã€‚nil â†’ []ã€Array â†’ ãã®ã¾ã¾ã€ãã‚Œä»¥å¤– â†’ [value]ã€‚Ruby ã® `Kernel#Array()` ã¨ä¼¼ã¦ã„ã¾ã™ãŒã€`Array(nil)` ãŒ `[]` ã‚’è¿”ã™ã®ã«å¯¾ã— `Array("foo")` ã¯ `["foo"]` ã‚’è¿”ã™ãªã©ã€ã‚ˆã‚Šç›´æ„Ÿçš„ãªå‹•ä½œã‚’ã—ã¾ã™ã€‚ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã§ã€Œé…åˆ—ã§ã‚‚å˜å€¤ã§ã‚‚å—ã‘ä»˜ã‘ãŸã„ã€å ´åˆã«é‡å®ã—ã¾ã™ã€‚',
    },
    {
      id: 'as9',
      category: 'ActiveSupport core-ext',
      categoryKey: 'activesupport',
      before: `users.each_with_object({}) { |u, h| h[u.id] = u }`,
      correct: `users.index_by(&:id)`,
      choices: [
        { text: `users.index_by(&:id)`, correct: true },
        { text: `users.to_h(&:id)`,     correct: false },
        { text: `users.key_by(&:id)`,   correct: false },
        { text: `users.group_by(&:id)`, correct: false },
      ],
      explanation: '`index_by` ã¯ãƒ–ãƒ­ãƒƒã‚¯ã®æˆ»ã‚Šå€¤ã‚’ã‚­ãƒ¼ã€è¦ç´ ã‚’å€¤ã¨ã™ã‚‹ãƒãƒƒã‚·ãƒ¥ã‚’ä½œã‚Šã¾ã™ã€‚`group_by` ã¯ã‚­ãƒ¼ãŒé‡è¤‡ã™ã‚‹å ´åˆã«é…åˆ—ã«ã¾ã¨ã‚ã¾ã™ãŒã€`index_by` ã¯ã‚­ãƒ¼ãŒãƒ¦ãƒ‹ãƒ¼ã‚¯ãªå ´åˆï¼ˆID ãªã©ï¼‰ã«ä½¿ã„ã€å€¤ã¯é…åˆ—ã§ãªãè¦ç´ ãã®ã‚‚ã®ã«ãªã‚Šã¾ã™ã€‚DB ã‹ã‚‰å–å¾—ã—ãŸãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’IDã§å¼•ã‘ã‚‹ãƒãƒƒã‚·ãƒ¥ã«ã™ã‚‹ã¨ãã«ã‚ˆãä½¿ã‚ã‚Œã¾ã™ã€‚',
    },
    {
      id: 'as10',
      category: 'ActiveSupport core-ext',
      categoryKey: 'activesupport',
      before: `str.length > 30 ? str[0...27] + "..." : str`,
      correct: `str.truncate(30)`,
      choices: [
        { text: `str.truncate(30)`,  correct: true },
        { text: `str.limit(30)`,     correct: false },
        { text: `str.ellipsis(30)`,  correct: false },
        { text: `str.shorten(30)`,   correct: false },
      ],
      explanation: '`truncate` ã¯æ–‡å­—åˆ—ã‚’æŒ‡å®šã®é•·ã•ã«åˆ‡ã‚Šè©°ã‚ã€æœ«å°¾ã«çœç•¥è¨˜å·ã‚’ä»˜ã‘ã¾ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®çœç•¥è¨˜å·ã¯ `"..."` ã§ã™ãŒã€`omission:` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§å¤‰æ›´ã§ãã¾ã™ã€‚ã¾ãŸ `separator:` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ã†ã¨å˜èªã®é€”ä¸­ã§åˆ‡ã‚‰ãªã„ã‚ˆã†ã«ã§ãã¾ã™ï¼ˆä¾‹: `str.truncate(30, separator: " ")`ï¼‰ã€‚',
    },
    {
      id: 'as11',
      category: 'ActiveSupport core-ext',
      categoryKey: 'activesupport',
      before: `Time.current + 7 * 24 * 60 * 60`,
      correct: `Time.current + 1.week`,
      choices: [
        { text: `Time.current + 1.week`,      correct: true },
        { text: `Time.current.add_weeks(1)`,  correct: false },
        { text: `Time.current + Week.new(1)`, correct: false },
        { text: `Time.current.week_later`,    correct: false },
      ],
      explanation: 'ActiveSupport ã¯ Integer / Float ã« `seconds`ã€`minutes`ã€`hours`ã€`days`ã€`weeks`ã€`months`ã€`years` ãªã©ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ ã—ã¾ã™ã€‚ã“ã‚Œã‚‰ã¯ `ActiveSupport::Duration` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã—ã€æ™‚åˆ»ã‚„æ—¥ä»˜ã¨ã®åŠ æ¸›ç®—ãŒã§ãã¾ã™ã€‚ã•ã‚‰ã« `1.week.from_now` ã‚„ `3.days.ago` ã®ã‚ˆã†ãªæ›¸ãæ–¹ã‚‚ã§ãã€Rails ã‚³ãƒ¼ãƒ‰ã§æ™‚é–“è¨ˆç®—ã‚’ç›´æ„Ÿçš„ã«è¨˜è¿°ã§ãã¾ã™ã€‚',
    },
    {
      id: 'as12',
      category: 'ActiveSupport core-ext',
      categoryKey: 'activesupport',
      before: `notifications.count > 1`,
      correct: `notifications.many?`,
      choices: [
        { text: `notifications.many?`,     correct: true },
        { text: `notifications.plural?`,   correct: false },
        { text: `notifications.multiple?`, correct: false },
        { text: `notifications.several?`,  correct: false },
      ],
      explanation: '`many?` ã¯è¦ç´ ãŒ 2ä»¶ä»¥ä¸Šã‚ã‚‹ã¨ã true ã‚’è¿”ã—ã¾ã™ï¼ˆ`count > 1` ã¨ç­‰ä¾¡ï¼‰ã€‚ãƒ–ãƒ­ãƒƒã‚¯ã‚’æ¸¡ã™ã“ã¨ã‚‚ã§ãã€`records.many? { |r| r.active? }` ã®ã‚ˆã†ã«æ¡ä»¶ä»˜ãã§ã€Œè¤‡æ•°ã‚ã‚‹ã‹ã€ã‚’ç¢ºèªã§ãã¾ã™ã€‚`any?`ãƒ»`none?`ãƒ»`one?`ãƒ»`many?` ã¨æ„å‘³ãŒæƒã£ã¦èª­ã¿ã‚„ã™ããªã‚Šã¾ã™ã€‚',
    },
  ],

  activerecord: [
    {
      id: 'ar1',
      category: 'Active Record',
      categoryKey: 'activerecord',
      before: `User.all.map(&:email)`,
      correct: `User.pluck(:email)`,
      choices: [
        { text: `User.pluck(:email)`,     correct: true },
        { text: `User.fetch(:email)`,     correct: false },
        { text: `User.pick(:email)`,      correct: false },
        { text: `User.collect(:email)`,   correct: false },
      ],
      explanation: '`pluck` ã¯ SQL ãƒ¬ãƒ™ãƒ«ã§æŒ‡å®šã‚«ãƒ©ãƒ ã ã‘å–å¾—ã—ã€ActiveRecord ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆã›ãšã«é…åˆ—ã‚’è¿”ã—ã¾ã™ã€‚`map(&:email)` ã¯å…¨ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ãƒ¡ãƒ¢ãƒªã«èª­ã¿è¾¼ã‚“ã§ã‹ã‚‰å±æ€§ã‚’å–ã‚Šå‡ºã™ãŸã‚ã€å¤§é‡ãƒ‡ãƒ¼ã‚¿ã§ã¯æ·±åˆ»ãªãƒ¡ãƒ¢ãƒªå•é¡Œã«ãªã‚Šã¾ã™ã€‚ãªãŠ `pick(:email)` ã¯1ä»¶ã ã‘å–å¾—ã™ã‚‹ Rails 6+ ã®ãƒ¡ã‚½ãƒƒãƒ‰ã§ã™ã€‚',
    },
    {
      id: 'ar2',
      category: 'Active Record',
      categoryKey: 'activerecord',
      before: `User.where(admin: true).count > 0`,
      correct: `User.where(admin: true).exists?`,
      choices: [
        { text: `User.where(admin: true).exists?`,  correct: true },
        { text: `User.where(admin: true).present?`, correct: false },
        { text: `User.where(admin: true).found?`,   correct: false },
        { text: `User.where(admin: true).has_any?`, correct: false },
      ],
      explanation: '`exists?` ã¯ EXISTS ã‚µãƒ–ã‚¯ã‚¨ãƒªã‚’ç™ºè¡Œã—ã€1ä»¶ã§ã‚‚è¦‹ã¤ã‹ã£ãŸæ™‚ç‚¹ã§è¿”ã‚Šã¾ã™ã€‚`count > 0` ã¯å…¨ä»¶æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆã—ã¦ã‹ã‚‰æ¯”è¼ƒã™ã‚‹ãŸã‚ã‚³ã‚¹ãƒˆãŒé«˜ãã€`present?` ã¯å…¨ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ãƒ¡ãƒ¢ãƒªã«èª­ã¿è¾¼ã‚€ãŸã‚ã•ã‚‰ã«æœ€æ‚ªã§ã™ã€‚å­˜åœ¨ç¢ºèªã«ã¯ `exists?` ä¸€æŠã§ã™ã€‚',
    },
    {
      id: 'ar3',
      category: 'Active Record',
      categoryKey: 'activerecord',
      before: `user = User.find_by(email: email)
user || User.create!(email: email)`,
      correct: `User.find_or_create_by(email: email)`,
      choices: [
        { text: `User.find_or_create_by(email: email)`, correct: true },
        { text: `User.find_or_build(email: email)`,      correct: false },
        { text: `User.where_or_create(email: email)`,    correct: false },
        { text: `User.upsert(email: email)`,             correct: false },
      ],
      explanation: '`find_or_create_by` ã¯æŒ‡å®šæ¡ä»¶ã§ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æ¤œç´¢ã—ã€ãªã‘ã‚Œã°ä½œæˆã—ã¾ã™ã€‚`find_or_initialize_by` ã‚’ä½¿ã†ã¨ DB ã«ã¯ä¿å­˜ã›ãšã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã ã‘ä½œã‚Œã¾ã™ã€‚ã¾ãŸ `find_or_create_by!` ã¯ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¤±æ•—æ™‚ã«ä¾‹å¤–ã‚’ç™ºç”Ÿã•ã›ã¾ã™ã€‚',
    },
    {
      id: 'ar4',
      category: 'Active Record',
      categoryKey: 'activerecord',
      before: `User.inactive.each { |u| u.update!(archived: true) }`,
      correct: `User.inactive.update_all(archived: true)`,
      choices: [
        { text: `User.inactive.update_all(archived: true)`,  correct: true },
        { text: `User.inactive.bulk_update(archived: true)`,  correct: false },
        { text: `User.inactive.batch_update(archived: true)`, correct: false },
        { text: `User.inactive.update_each(archived: true)`,  correct: false },
      ],
      explanation: '`update_all` ã¯å˜ä¸€ã® UPDATE SQL ã‚’ç™ºè¡Œã—ã€ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚„æ¤œè¨¼ã‚’ä»‹ã•ãšã«ä¸€æ‹¬æ›´æ–°ã—ã¾ã™ã€‚`each` ãƒ«ãƒ¼ãƒ—ã¯ N å›ã® UPDATE ã‚’ç™ºè¡Œã—ã€å„ãƒ¬ã‚³ãƒ¼ãƒ‰ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚‚å‹•ããŸã‚éå¸¸ã«ä½é€Ÿã§ã™ã€‚ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ä¸è¦ã®ä¸€æ‹¬æ›´æ–°ã«ã¯ `update_all` ã‚’ä½¿ã„ã¾ã—ã‚‡ã†ã€‚',
    },
    {
      id: 'ar5',
      category: 'Active Record',
      categoryKey: 'activerecord',
      before: `User.where("status != ?", "inactive")`,
      correct: `User.where.not(status: "inactive")`,
      choices: [
        { text: `User.where.not(status: "inactive")`,    correct: true },
        { text: `User.where.exclude(status: "inactive")`, correct: false },
        { text: `User.where.except(status: "inactive")`,  correct: false },
        { text: `User.without(status: "inactive")`,       correct: false },
      ],
      explanation: '`where.not` ã¯ãƒãƒƒã‚·ãƒ¥æ§‹æ–‡ã§ NOT æ¡ä»¶ã‚’æ›¸ã‘ã¾ã™ã€‚æ–‡å­—åˆ—æ¡ä»¶ã‚ˆã‚Šå®‰å…¨ï¼ˆSQL ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ãƒªã‚¹ã‚¯ãŒä¸‹ãŒã‚‹ï¼‰ã§ã€ã‚«ãƒ©ãƒ åã‚’ã‚·ãƒ³ãƒœãƒ«ã§æ›¸ã‘ã‚‹ãŸã‚ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã«ã‚‚å¼·ããªã‚Šã¾ã™ã€‚è¤‡æ•°æ¡ä»¶ã® AND NOT ã«ã‚‚å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚',
    },
    {
      id: 'ar6',
      category: 'Active Record',
      categoryKey: 'activerecord',
      before: `User.all.each { |u| send_newsletter(u) }`,
      correct: `User.find_each { |u| send_newsletter(u) }`,
      choices: [
        { text: `User.find_each { |u| send_newsletter(u) }`,   correct: true },
        { text: `User.batch_each { |u| send_newsletter(u) }`,  correct: false },
        { text: `User.each_batch { |u| send_newsletter(u) }`,  correct: false },
        { text: `User.stream_each { |u| send_newsletter(u) }`, correct: false },
      ],
      explanation: '`find_each` ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ 1000 ä»¶ãšã¤ãƒãƒƒãƒã§ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ã—ã¾ã™ã€‚`all.each` ã¯å…¨ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä¸€åº¦ã«ãƒ¡ãƒ¢ãƒªã«èª­ã¿è¾¼ã‚€ãŸã‚ã€å¤§é‡ãƒ‡ãƒ¼ã‚¿ã§ã¯ OutOfMemoryError ã®åŸå› ã«ãªã‚Šã¾ã™ã€‚`batch_size:` ã§ãƒãƒƒãƒã‚µã‚¤ã‚ºã‚’å¤‰æ›´ã§ãã€`find_in_batches` ã‚’ä½¿ã†ã¨ãƒãƒƒãƒé…åˆ—ã”ã¨ã«å‡¦ç†ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚',
    },
  ],

  viewhelper: [
    {
      id: 'vh1',
      category: 'View Helper',
      categoryKey: 'viewhelper',
      before: `seconds_ago = Time.current - post.created_at
"#{(seconds_ago / 60).to_i} åˆ†å‰"`,
      correct: `time_ago_in_words(post.created_at)`,
      choices: [
        { text: `time_ago_in_words(post.created_at)`, correct: true },
        { text: `relative_time(post.created_at)`,      correct: false },
        { text: `humanize_time(post.created_at)`,      correct: false },
        { text: `ago_in_words(post.created_at)`,       correct: false },
      ],
      explanation: '`time_ago_in_words` ã¯ãƒ­ã‚±ãƒ¼ãƒ«å¯¾å¿œã®ç›¸å¯¾æ™‚é–“è¡¨ç¤ºã‚’è¿”ã—ã¾ã™ã€‚ã€Œless than a minuteã€ã€Œ3 minutesã€ã€Œabout 2 hoursã€ã€Œ3 daysã€ã®ã‚ˆã†ã«è‡ªå‹•ã§å˜ä½ã‚’å¤‰ãˆã¦ãã‚Œã¾ã™ã€‚I18n ãƒ­ã‚±ãƒ¼ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¨­å®šã™ã‚Œã°ã€Œ3åˆ†å‰ã€ã€Œç´„2æ™‚é–“å‰ã€ã¨æ—¥æœ¬èªåŒ–ã§ãã¾ã™ã€‚',
    },
    {
      id: 'vh2',
      category: 'View Helper',
      categoryKey: 'viewhelper',
      before: `"#{count} #{count == 1 ? 'comment' : 'comments'}"`,
      correct: `pluralize(count, 'comment')`,
      choices: [
        { text: `pluralize(count, 'comment')`,      correct: true },
        { text: `inflect(count, 'comment')`,         correct: false },
        { text: `count_label(count, 'comment')`,     correct: false },
        { text: `humanize_count(count, 'comment')`,  correct: false },
      ],
      explanation: '`pluralize` ã¯ã‚«ã‚¦ãƒ³ãƒˆãŒ 1 ã®ã¨ãå˜æ•°å½¢ã€ãã‚Œä»¥å¤–ã§è¤‡æ•°å½¢ã‚’è¿”ã—ã¾ã™ã€‚`pluralize(count, "person", plural: "people")` ã®ã‚ˆã†ã«ä¸è¦å‰‡å¤‰åŒ–ã«ã‚‚å¯¾å¿œã§ãã¾ã™ã€‚`1 comment` / `3 comments` ã®ã‚ˆã†ãªè¡¨ç¤ºã«å¿…é ˆã®ãƒ˜ãƒ«ãƒ‘ãƒ¼ã§ã™ã€‚',
    },
    {
      id: 'vh3',
      category: 'View Helper',
      categoryKey: 'viewhelper',
      before: `"Â¥#{price.to_s.chars.reverse.each_slice(3).map(&:join).join(',').reverse}"`,
      correct: `number_to_currency(price, unit: "Â¥", format: "%u%n")`,
      choices: [
        { text: `number_to_currency(price, unit: "Â¥", format: "%u%n")`, correct: true },
        { text: `format_currency(price, "Â¥")`,                           correct: false },
        { text: `to_currency(price, symbol: "Â¥")`,                       correct: false },
        { text: `price.to_currency("Â¥")`,                                correct: false },
      ],
      explanation: '`number_to_currency` ã¯3æ¡ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã‚„é€šè²¨è¨˜å·ã‚’è‡ªå‹•ä»˜åŠ ã—ã¾ã™ã€‚I18n è¨­å®šã¨çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ $1,234.56 / â‚¬1.234,56 / Â¥1,235 ã®ã‚ˆã†ã«ãƒ­ã‚±ãƒ¼ãƒ«ã”ã¨ã®è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚`precision:` ã§å°æ•°ç‚¹æ¡æ•°ã‚‚ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã§ãã¾ã™ã€‚',
    },
    {
      id: 'vh4',
      category: 'View Helper',
      categoryKey: 'viewhelper',
      before: `"<div class=\\"alert alert-#{type}\\">#{message}</div>".html_safe`,
      correct: `content_tag(:div, message, class: "alert alert-#{type}")`,
      choices: [
        { text: `content_tag(:div, message, class: "alert alert-#{type}")`, correct: true },
        { text: `html_tag(:div, message, class: "alert alert-#{type}")`,    correct: false },
        { text: `wrap_tag(:div, message, class: "alert alert-#{type}")`,    correct: false },
        { text: `render_tag(:div, message, class: "alert alert-#{type}")`,  correct: false },
      ],
      explanation: '`content_tag` ã¯ HTML ã‚¿ã‚°ã‚’ç”Ÿæˆã—ã€ä¸­èº«ã‚’è‡ªå‹•ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã™ã‚‹ãŸã‚ XSS ã«å®‰å…¨ã§ã™ã€‚`.html_safe` ã‚’æ‰‹ã§ä»˜ã‘ã‚‹æ–¹æ³•ã¯ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†ã‚’æ‰‹å‹•ç®¡ç†ã™ã‚‹ãƒªã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚Rails 6.1 ä»¥é™ã¯ `tag.div { message }` ã¨ã„ã†ã‚¿ã‚°ãƒ“ãƒ«ãƒ€ãƒ¼æ§‹æ–‡ã‚‚ä½¿ãˆã¾ã™ã€‚',
    },
    {
      id: 'vh5',
      category: 'View Helper',
      categoryKey: 'viewhelper',
      before: `"#{(file.size / 1024.0 / 1024).round(1)} MB"`,
      correct: `number_to_human_size(file.size)`,
      choices: [
        { text: `number_to_human_size(file.size)`, correct: true },
        { text: `file_size_tag(file.size)`,         correct: false },
        { text: `format_bytes(file.size)`,           correct: false },
        { text: `humanize_size(file.size)`,          correct: false },
      ],
      explanation: '`number_to_human_size` ã¯ãƒã‚¤ãƒˆæ•°ã‚’è‡ªå‹•ã§é©åˆ‡ãªå˜ä½ï¼ˆBytes / KB / MB / GB / TBï¼‰ã«å¤‰æ›ã—ã¾ã™ã€‚MB å›ºå®šã§è¡¨ç¤ºã™ã‚‹ã‚³ãƒ¼ãƒ‰ã¨ç•°ãªã‚Šã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã«å¿œã˜ã¦ã€Œ512 Bytesã€ã€Œ4.2 KBã€ã€Œ1.23 GBã€ã¨è‡ªå‹•çš„ã«å˜ä½ãŒåˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã™ã€‚',
    },
    {
      id: 'vh6',
      category: 'View Helper',
      categoryKey: 'viewhelper',
      before: `posts.each_with_index do |post, i|
  row_class = i.even? ? "bg-white" : "bg-gray-100"
end`,
      correct: `cycle("bg-white", "bg-gray-100")`,
      choices: [
        { text: `cycle("bg-white", "bg-gray-100")`,    correct: true },
        { text: `alternate("bg-white", "bg-gray-100")`, correct: false },
        { text: `toggle("bg-white", "bg-gray-100")`,    correct: false },
        { text: `rotate("bg-white", "bg-gray-100")`,    correct: false },
      ],
      explanation: '`cycle` ã¯ãƒ“ãƒ¥ãƒ¼å†…ã§å‘¼ã³å‡ºã™ãŸã³ã«å¼•æ•°ã‚’é †ç•ªã«è¿”ã—ã¾ã™ã€‚ãƒ†ãƒ¼ãƒ–ãƒ«ã®è¡Œã®èƒŒæ™¯è‰²äº¤äº’è¡¨ç¤ºã«ã‚ˆãä½¿ã‚ã‚Œã¾ã™ã€‚2ã¤ä»¥ä¸Šã®å€¤ã§3è‰²ä»¥ä¸Šã®ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚‚å¯¾å¿œã§ãã€`name:` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§è¤‡æ•°ã®ç‹¬ç«‹ã—ãŸã‚µã‚¤ã‚¯ãƒ«ã‚’åŒä¸€ãƒ“ãƒ¥ãƒ¼ã§ä½¿ã„åˆ†ã‘ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚',
    },
  ],
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ã‚²ãƒ¼ãƒ çŠ¶æ…‹
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentCategory = null;
let currentQuestions  = [];
let currentIndex      = 0;
let score             = 0;
let answered          = false;
let categoryAnswers   = {};   // { activesupport: {correct:0, total:0}, ... }

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ç”»é¢åˆ‡æ›¿
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showScreen(name) {
  document.querySelectorAll('[id^="screen-"]').forEach(el => el.classList.add('hidden'));
  document.getElementById(`screen-${name}`).classList.remove('hidden');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ã‚¯ã‚¤ã‚ºé–‹å§‹
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startCategory(category) {
  currentCategory = category;
  currentQuestions = shuffle([...ALL_QUESTIONS[category]]);
  initQuiz();
}

function startAllCategories() {
  currentCategory = '__all__';
  const all = Object.values(ALL_QUESTIONS).flat();
  currentQuestions = shuffle(all);
  initQuiz();
}

function initQuiz() {
  currentIndex = 0;
  score = 0;
  categoryAnswers = {
    activesupport: { correct: 0, total: 0 },
    activerecord:  { correct: 0, total: 0 },
    viewhelper:    { correct: 0, total: 0 },
  };
  showScreen('quiz');
  renderQuestion();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  å•é¡Œãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderQuestion() {
  const q = currentQuestions[currentIndex];
  answered = false;

  // ãƒ˜ãƒƒãƒ€ãƒ¼æ›´æ–°
  document.getElementById('q-current').textContent = currentIndex + 1;
  document.getElementById('q-total').textContent   = currentQuestions.length;
  document.getElementById('q-score').textContent   = score;

  // ã‚«ãƒ†ã‚´ãƒªãƒãƒƒã‚¸
  const badge = document.getElementById('q-category-badge');
  badge.textContent = q.category;

  // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼
  const pct = (currentIndex / currentQuestions.length) * 100;
  document.getElementById('progress-bar').style.width = `${pct}%`;

  // Before ã‚³ãƒ¼ãƒ‰
  const beforeEl = document.getElementById('q-before-code');
  beforeEl.removeAttribute('data-highlighted');
  beforeEl.textContent = q.before;
  hljs.highlightElement(beforeEl);

  // é¸æŠè‚¢
  const choicesEl = document.getElementById('q-choices');
  choicesEl.innerHTML = '';
  const shuffled = shuffle([...q.choices]);

  shuffled.forEach((choice, i) => {
    const btn = document.createElement('button');
    btn.className = [
      'choice-btn w-full text-left flex items-start gap-3 p-4 rounded-xl',
      'border border-gray-700 bg-gray-900/80 hover:bg-gray-800 hover:border-gray-500',
    ].join(' ');

    const label = document.createElement('span');
    label.className = 'text-gray-500 font-mono text-sm shrink-0 mt-0.5';
    label.textContent = `${String.fromCharCode(65 + i)})`;

    const codeWrap = document.createElement('pre');
    codeWrap.className = 'bg-transparent m-0 p-0 overflow-x-auto flex-1';
    const codeEl = document.createElement('code');
    codeEl.className = 'language-ruby text-sm !bg-transparent !p-0';
    codeEl.textContent = choice.text;
    codeWrap.appendChild(codeEl);

    btn.appendChild(label);
    btn.appendChild(codeWrap);
    btn.onclick = () => selectChoice(choice, btn, shuffled);
    choicesEl.appendChild(btn);
    hljs.highlightElement(codeEl);
  });

  // è§£èª¬ãƒ»æ¬¡ã¸ãƒœã‚¿ãƒ³ã‚’éš ã™
  document.getElementById('q-explanation').classList.add('hidden');
  document.getElementById('btn-next').classList.add('hidden');

  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  é¸æŠè‚¢ã‚¯ãƒªãƒƒã‚¯
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selectChoice(choice, clickedBtn, allChoices) {
  if (answered) return;
  answered = true;

  const q = currentQuestions[currentIndex];
  const allBtns = document.querySelectorAll('.choice-btn');

  allBtns.forEach(b => { b.disabled = true; });

  // æ­£è§£ãƒœã‚¿ãƒ³ã‚’ã‚°ãƒªãƒ¼ãƒ³ã«
  allBtns.forEach((b, i) => {
    if (allChoices[i].correct) {
      b.classList.remove('border-gray-700', 'bg-gray-900/80');
      b.classList.add('border-green-500', 'bg-green-900/40', 'correct-glow');
    }
  });

  if (choice.correct) {
    score++;
    document.getElementById('q-score').textContent = score;
    const scoreEl = document.getElementById('q-score');
    scoreEl.classList.remove('score-pulse');
    void scoreEl.offsetWidth;
    scoreEl.classList.add('score-pulse');
  } else {
    // é¸ã‚“ã ãƒœã‚¿ãƒ³ã‚’ãƒ¬ãƒƒãƒ‰ã«
    clickedBtn.classList.remove('border-gray-700', 'bg-gray-900/80');
    clickedBtn.classList.add('border-red-500', 'bg-red-900/40', 'wrong-glow');
    clickedBtn.classList.add('shake');
  }

  // ã‚«ãƒ†ã‚´ãƒªã‚¹ã‚³ã‚¢è¨˜éŒ²
  const cat = q.categoryKey;
  categoryAnswers[cat].total++;
  if (choice.correct) categoryAnswers[cat].correct++;

  // è§£èª¬è¡¨ç¤º
  const afterEl = document.getElementById('q-after-code');
  afterEl.removeAttribute('data-highlighted');
  afterEl.textContent = q.correct;
  hljs.highlightElement(afterEl);

  document.getElementById('q-explanation-text').textContent = q.explanation;

  // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒªãƒ³ã‚¯
  const docLink  = document.getElementById('q-doc-link');
  const docLabel = document.getElementById('q-doc-label');
  const doc = DOC_URLS[q.id];
  if (doc) {
    docLink.href = doc.url;
    docLabel.textContent = doc.label;
    docLink.classList.remove('hidden');
  } else {
    docLink.classList.add('hidden');
  }

  document.getElementById('q-explanation').classList.remove('hidden');
  document.getElementById('btn-next').classList.remove('hidden');

  setTimeout(() => {
    document.getElementById('q-explanation').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }, 150);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  æ¬¡ã®å•é¡Œ
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function nextQuestion() {
  currentIndex++;
  if (currentIndex >= currentQuestions.length) {
    showResult();
  } else {
    renderQuestion();
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ãƒªã‚¶ãƒ«ãƒˆç”»é¢
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showResult() {
  showScreen('result');
  const total = currentQuestions.length;
  document.getElementById('result-score').textContent = score;
  document.getElementById('result-total').textContent  = total;

  const pct = score / total;
  let emoji, msg;
  if (pct >= 0.9) { emoji = 'ğŸ†'; msg = 'å®Œç’§ï¼Rails ãƒã‚¹ã‚¿ãƒ¼ã§ã™ã­ï¼'; }
  else if (pct >= 0.7) { emoji = 'ğŸ‰'; msg = 'ç´ æ™´ã‚‰ã—ã„ï¼Rails ã®æ›¸ãæ–¹ã‚’ã‚ˆãç†è§£ã—ã¦ã„ã¾ã™ï¼'; }
  else if (pct >= 0.5) { emoji = 'ğŸ‘'; msg = 'è‰¯ã„èª¿å­ï¼ã‚‚ã†å°‘ã—ç·´ç¿’ã™ã‚Œã°å®Œç’§ã§ã™ï¼'; }
  else { emoji = 'ğŸ“š'; msg = 'Rails ã®é­”æ³•ã‚’ã‚‚ã£ã¨å­¦ã‚“ã§ã¿ã¾ã—ã‚‡ã†ï¼'; }

  document.getElementById('result-emoji').textContent   = emoji;
  document.getElementById('result-message').textContent = msg;

  // æ˜Ÿ
  const stars = Math.round(pct * 5);
  document.getElementById('result-stars').textContent = 'â­'.repeat(stars) + 'â˜†'.repeat(5 - stars);

  // ã‚«ãƒ†ã‚´ãƒªåˆ¥
  const rows = document.getElementById('breakdown-rows');
  const catInfo = {
    activesupport: { label: 'âš¡ ActiveSupport', barClass: 'bg-indigo-500' },
    activerecord:  { label: 'ğŸ—„ï¸ Active Record',  barClass: 'bg-emerald-500' },
    viewhelper:    { label: 'ğŸ¨ View Helper',    barClass: 'bg-rose-500' },
  };
  rows.innerHTML = Object.entries(categoryAnswers).map(([cat, {correct, total: t}]) => {
    if (t === 0) return '';
    const c = catInfo[cat];
    const catPct = t > 0 ? Math.round((correct / t) * 100) : 0;
    return `
      <div class="flex items-center justify-between py-3 border-b border-gray-800 last:border-0">
        <span class="text-gray-300">${c.label}</span>
        <div class="flex items-center gap-3">
          <div class="w-24 bg-gray-800 rounded-full h-1.5">
            <div class="h-1.5 rounded-full ${c.barClass}" style="width:${catPct}%"></div>
          </div>
          <span class="text-yellow-400 font-bold tabular-nums w-12 text-right">${correct} / ${t}</span>
        </div>
      </div>`;
  }).join('');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function goHome() { showScreen('home'); }

function retryCurrentCategory() {
  if (currentCategory === '__all__') {
    startAllCategories();
  } else {
    startCategory(currentCategory);
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ã‚°ãƒ­ãƒ¼ãƒãƒ«å…¬é–‹
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.goHome               = goHome;
window.startAllCategories   = startAllCategories;
window.nextQuestion         = nextQuestion;
window.retryCurrentCategory = retryCurrentCategory;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ã‚«ãƒ†ã‚´ãƒªã‚«ãƒ¼ãƒ‰
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.category-card').forEach(card => {
  card.addEventListener('click', () => startCategory(card.dataset.category));
});

</script>
</body>
</html>
