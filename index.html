<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rails Magic Quiz ğŸ©</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/ruby.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', system-ui, sans-serif; }

    .choice-btn {
      transition: transform 0.1s ease, box-shadow 0.1s ease;
    }
    .choice-btn:not(:disabled):hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .choice-btn:not(:disabled):active {
      transform: translateY(0);
    }
    .choice-btn:disabled { cursor: not-allowed; }

    .category-card {
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .category-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    }

    pre code.hljs { border-radius: 0.5rem; padding: 1.25rem; font-size: 0.85rem; }

    .fade-in { animation: fadeIn 0.25s ease; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(6px); } to { opacity:1; transform:translateY(0); } }

    .shake { animation: shake 0.35s ease; }
    @keyframes shake {
      0%,100% { transform: translateX(0); }
      20%,60%  { transform: translateX(-5px); }
      40%,80%  { transform: translateX(5px); }
    }

    .correct-glow { box-shadow: 0 0 16px rgba(74,222,128,0.5); }
    .wrong-glow   { box-shadow: 0 0 16px rgba(248,113,113,0.5); }

    /* Progress bar shimmer */
    #progress-bar { background: linear-gradient(90deg, #6366f1, #8b5cf6); }

    /* Score badge pulse on update */
    .score-pulse { animation: scorePulse 0.4s ease; }
    @keyframes scorePulse { 0%,100% { transform:scale(1); } 50% { transform:scale(1.3); color:#fbbf24; } }
  </style>
</head>
<body class="bg-gray-950 text-gray-100 min-h-screen">

<!-- ============================= HOME ============================= -->
<div id="screen-home" class="min-h-screen flex flex-col items-center justify-center p-6">
  <div class="text-center mb-12">
    <div class="text-7xl mb-4">ğŸ©</div>
    <h1 class="text-5xl font-extrabold mb-3 bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent">
      Rails Magic Quiz
    </h1>
    <p class="text-lg text-gray-400">Pure Ruby ã®ã‚³ãƒ¼ãƒ‰ã‚’ Rails ã‚‰ã—ãæ›¸ãæ›ãˆã‚ˆã†ï¼</p>
  </div>

  <div class="w-full max-w-sm mb-8">
    <div class="category-card bg-indigo-900/60 border border-indigo-700/50 hover:border-indigo-500 rounded-2xl p-8 cursor-pointer text-center"
         data-category="activesupport">
      <div class="text-5xl mb-4">âš¡</div>
      <h2 class="text-2xl font-bold mb-2">ActiveSupport</h2>
      <p class="text-indigo-300 text-sm mb-5">blank?, present?, presence, in?, try, deep_merge</p>
      <span class="text-xs bg-indigo-800 text-indigo-300 px-3 py-1 rounded-full">7 å•</span>
    </div>
  </div>

  <button onclick="startCategory('activesupport')"
          class="px-8 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500
                 rounded-full text-lg font-bold transition-all shadow-lg hover:shadow-indigo-500/30">
    æŒ‘æˆ¦ã™ã‚‹ï¼ ğŸš€
  </button>

</div>

<!-- ============================= QUIZ ============================= -->
<div id="screen-quiz" class="hidden min-h-screen flex flex-col">
  <!-- sticky header -->
  <div class="sticky top-0 z-10 bg-gray-950/95 backdrop-blur border-b border-gray-800 px-6 py-3">
    <div class="max-w-3xl mx-auto flex items-center justify-between">
      <button onclick="goHome()" class="text-sm text-gray-500 hover:text-gray-300 transition-colors">
        â† ãƒ›ãƒ¼ãƒ 
      </button>
      <div class="flex items-center gap-4 text-sm">
        <span class="text-gray-400">
          <span id="q-current" class="text-white font-bold">1</span>
          <span class="text-gray-600"> / </span>
          <span id="q-total">6</span>
        </span>
        <span id="q-category-badge" class="hidden sm:inline-block text-xs px-3 py-1 rounded-full bg-gray-800 text-gray-300"></span>
        <div class="flex items-center gap-2 bg-gray-800 px-4 py-1 rounded-full">
          <span class="text-gray-400 text-xs">ã‚¹ã‚³ã‚¢</span>
          <span id="q-score" class="font-bold text-yellow-400 text-lg">0</span>
        </div>
      </div>
    </div>
    <!-- progress bar -->
    <div class="max-w-3xl mx-auto mt-2">
      <div class="w-full bg-gray-800 rounded-full h-1.5">
        <div id="progress-bar" class="h-1.5 rounded-full transition-all duration-500" style="width: 0%"></div>
      </div>
    </div>
  </div>

  <!-- question body -->
  <div class="flex-1 max-w-3xl mx-auto w-full px-4 py-8" id="quiz-body">

    <div class="mb-2 text-sm text-gray-500 font-medium">ã“ã‚“ãªã‚³ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã™ï¼š</div>

    <!-- before code -->
    <div class="mb-6">
      <div class="flex items-center gap-2 mb-2">
        <span class="text-xs bg-red-900/50 text-red-300 border border-red-800/50 px-2 py-0.5 rounded font-mono">Before</span>
        <span class="text-xs text-gray-600">Pure Ruby ã®ã‚³ãƒ¼ãƒ‰</span>
      </div>
      <pre class="rounded-xl overflow-auto"><code id="q-before-code" class="language-ruby"></code></pre>
    </div>

    <div class="text-lg font-semibold mb-4 text-gray-200">âœ¨ Rails ã‚‰ã—ãæ›¸ãã¨ã©ã‚Œï¼Ÿ</div>

    <!-- choices -->
    <div id="q-choices" class="flex flex-col gap-3 mb-6"></div>

    <!-- explanation (shown after answering) -->
    <div id="q-explanation" class="hidden fade-in mt-6 rounded-2xl overflow-hidden border border-gray-700">
      <div class="px-5 py-4 bg-gray-800/80">
        <div class="flex items-center justify-between mb-3">
          <span class="text-green-400 font-bold">ğŸ’¡ è§£èª¬</span>
          <a id="q-doc-link" href="#" target="_blank" rel="noopener noreferrer"
             class="hidden text-xs text-indigo-400 hover:text-indigo-300 flex items-center gap-1 transition-colors">
            ğŸ“– <span id="q-doc-label">ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ</span> â†—
          </a>
        </div>
        <p id="q-explanation-text" class="text-gray-300 text-sm leading-relaxed"></p>
      </div>

      <!-- after code -->
      <div class="px-5 pb-4 bg-gray-800/80">
        <div class="flex items-center gap-2 mb-2">
          <span class="text-xs bg-green-900/50 text-green-300 border border-green-800/50 px-2 py-0.5 rounded font-mono">After</span>
          <span class="text-xs text-gray-600">Rails ã‚‰ã—ã„ã‚³ãƒ¼ãƒ‰</span>
        </div>
        <pre class="rounded-xl overflow-auto"><code id="q-after-code" class="language-ruby"></code></pre>
      </div>

    </div>

    <!-- next button -->
    <div class="mt-6 flex justify-end">
      <button id="btn-next" onclick="nextQuestion()"
              class="hidden px-6 py-2.5 bg-indigo-600 hover:bg-indigo-500 rounded-xl font-bold transition-all
                     shadow-lg hover:shadow-indigo-500/30">
        æ¬¡ã®å•é¡Œ â†’
      </button>
    </div>
  </div>
</div>

<!-- ============================= RESULT ============================= -->
<div id="screen-result" class="hidden min-h-screen flex flex-col items-center justify-center p-6">
  <div class="text-center max-w-lg w-full">
    <div id="result-emoji" class="text-8xl mb-6 fade-in">ğŸ‰</div>
    <h2 class="text-3xl font-extrabold mb-2">ã‚¯ãƒªã‚¢ï¼</h2>

    <div class="flex items-baseline justify-center gap-2 my-6">
      <span id="result-score" class="text-7xl font-extrabold text-yellow-400"></span>
      <span class="text-3xl text-gray-600">/</span>
      <span id="result-total" class="text-3xl text-gray-400"></span>
    </div>

    <p id="result-message" class="text-lg text-gray-300 mb-8"></p>

    <!-- stars -->
    <div id="result-stars" class="text-4xl mb-6"></div>

    <!-- category breakdown -->
    <div id="result-breakdown" class="bg-gray-900 border border-gray-800 rounded-2xl p-6 mb-8 text-left">
      <h3 class="font-bold text-gray-400 text-sm mb-4 uppercase tracking-wider">ã‚«ãƒ†ã‚´ãƒªåˆ¥ã‚¹ã‚³ã‚¢</h3>
      <div id="breakdown-rows"></div>
    </div>

    <div class="flex flex-wrap gap-3 justify-center">
      <button onclick="retryCurrentCategory()"
              class="px-6 py-2.5 bg-indigo-600 hover:bg-indigo-500 rounded-full font-bold transition-all">
        ã‚‚ã†ä¸€åº¦ ğŸ”„
      </button>
      <button onclick="goHome()"
              class="px-6 py-2.5 bg-gray-800 hover:bg-gray-700 rounded-full font-bold transition-all">
        ã‚«ãƒ†ã‚´ãƒªé¸æŠ ğŸ 
      </button>
    </div>
  </div>
</div>

<!-- ============================= SCRIPT ============================= -->
<script type="module">

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ URL ãƒ†ãƒ¼ãƒ–ãƒ«
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DOC_URLS = {
  as1:   { url: 'https://api.rubyonrails.org/classes/Object.html#method-i-blank-3F',   label: 'Rails API â€” Object#blank?' },
  as2:   { url: 'https://api.rubyonrails.org/classes/Object.html#method-i-present-3F', label: 'Rails API â€” Object#present?' },
  as3:   { url: 'https://api.rubyonrails.org/classes/Object.html#method-i-presence',   label: 'Rails API â€” Object#presence' },
  as4:   { url: 'https://api.rubyonrails.org/classes/Object.html#method-i-in-3F',      label: 'Rails API â€” Object#in?' },
  as5:   { url: 'https://api.rubyonrails.org/classes/Object.html#method-i-try',        label: 'Rails API â€” Object#try' },
  as6:   { url: 'https://api.rubyonrails.org/classes/Object.html#method-i-in-3F',      label: 'Rails API â€” Object#in?' },
  hash5: { url: 'https://api.rubyonrails.org/classes/Hash.html#method-i-deep_merge',   label: 'Rails API â€” Hash#deep_merge' },
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  å•é¡Œãƒ‡ãƒ¼ã‚¿
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ALL_QUESTIONS = {
  activesupport: [
    {
      id: 'as1',
      category: 'ActiveSupport core-ext',
      categoryKey: 'activesupport',
      before: `str.nil? || str == ""`,
      correct: `str.blank?`,
      choices: [
        { text: `str.blank?`, correct: true },
        { text: `str.nil? || str.empty?`, correct: false },
        { text: `str.empty?`, correct: false },
        { text: `str.absent?`, correct: false },
      ],
      explanation: '`blank?` ã¯ ActiveSupport ãŒæä¾›ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã§ã™ã€‚nilãƒ»ç©ºæ–‡å­—ãƒ»ç©ºç™½ã®ã¿ã®æ–‡å­—åˆ—ãƒ»ç©ºé…åˆ—ãƒ»ç©ºãƒãƒƒã‚·ãƒ¥ã™ã¹ã¦ã« true ã‚’è¿”ã—ã¾ã™ã€‚`nil.blank?` ã‚‚å®‰å…¨ã«å‘¼ã³å‡ºã›ã‚‹ãŸã‚ nil ãƒã‚§ãƒƒã‚¯ãŒä¸è¦ã«ãªã‚Šã¾ã™ã€‚',
    },
    {
      id: 'as2',
      category: 'ActiveSupport core-ext',
      categoryKey: 'activesupport',
      before: `!name.nil? && name != ""`,
      correct: `name.present?`,
      choices: [
        { text: `name.present?`, correct: true },
        { text: `!name.blank?`, correct: false },
        { text: `name.exists?`, correct: false },
        { text: `name.filled?`, correct: false },
      ],
      explanation: '`present?` ã¯ `blank?` ã®åå¯¾ã§ã€å€¤ãŒå­˜åœ¨ã™ã‚‹ï¼ˆnil ã§ã‚‚ç©ºã§ã‚‚ãªã„ï¼‰å ´åˆã« true ã‚’è¿”ã—ã¾ã™ã€‚`!name.blank?` ã§ã‚‚åŒã˜ã§ã™ãŒã€`present?` ã®æ–¹ãŒæ„å›³ãŒæ˜ç¢ºã§èª­ã¿ã‚„ã™ã„ã‚³ãƒ¼ãƒ‰ã«ãªã‚Šã¾ã™ã€‚',
    },
    {
      id: 'as3',
      category: 'ActiveSupport core-ext',
      categoryKey: 'activesupport',
      before: `params[:name].present? ? params[:name] : nil`,
      correct: `params[:name].presence`,
      choices: [
        { text: `params[:name].presence`, correct: true },
        { text: `params[:name].or_nil`, correct: false },
        { text: `params[:name].to_presence`, correct: false },
        { text: `params[:name].present_value`, correct: false },
      ],
      explanation: '`presence` ã¯ `present?` ãªã‚‰ self ã‚’ã€`blank?` ãªã‚‰ nil ã‚’è¿”ã—ã¾ã™ã€‚`x.present? ? x : nil` ã¨å®Œå…¨ã«ç­‰ä¾¡ã§ã™ã€‚DB ã®ç©ºæ–‡å­—åˆ—ã‚’ nil ã¨ã—ã¦æ‰±ã†éš›ãªã©ã«ç‰¹ã«æœ‰ç”¨ã§ã™ã€‚',
    },
    {
      id: 'as4',
      category: 'ActiveSupport core-ext',
      categoryKey: 'activesupport',
      before: `[1, 2, 3].include?(x)`,
      correct: `x.in?([1, 2, 3])`,
      choices: [
        { text: `x.in?([1, 2, 3])`, correct: true },
        { text: `[1, 2, 3].has?(x)`, correct: false },
        { text: `x.included_in?([1, 2, 3])`, correct: false },
        { text: `[1, 2, 3].contains?(x)`, correct: false },
      ],
      explanation: '`in?` ã¯ãƒ¬ã‚·ãƒ¼ãƒãƒ¼ãŒã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«å«ã¾ã‚Œã‚‹ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚ã€Œx ãŒ [1,2,3] ã®ä¸­ã«ã‚ã‚‹ï¼Ÿã€ã¨ã„ã†è‹±èªã®è‡ªç„¶ãªèªé †ã§æ›¸ã‘ã‚‹ãŸã‚ã€æ¡ä»¶åˆ†å²ã®ä¸­ã§ã‚ˆã‚Šèª­ã¿ã‚„ã™ã„ã‚³ãƒ¼ãƒ‰ã«ãªã‚Šã¾ã™ã€‚Range ã‚„ Set ãªã© `include?` ã‚’æŒã¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãªã‚‰ã™ã¹ã¦ä½¿ãˆã¾ã™ã€‚',
    },
    {
      id: 'as5',
      category: 'ActiveSupport core-ext',
      categoryKey: 'activesupport',
      before: `user ? user.name : nil`,
      correct: `user.try(:name)`,
      choices: [
        { text: `user.try(:name)`, correct: true },
        { text: `user.safe(:name)`, correct: false },
        { text: `user.try.name`, correct: false },
        { text: `user&.name rescue nil`, correct: false },
      ],
      explanation: '`try` ã¯ nil-safe ãªãƒ¡ã‚½ãƒƒãƒ‰å‘¼ã³å‡ºã—ã§ã™ã€‚ãƒ¬ã‚·ãƒ¼ãƒãƒ¼ãŒ nil ãªã‚‰ nil ã‚’è¿”ã—ã€ãã†ã§ãªã‘ã‚Œã°ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚ãªãŠ Ruby 2.3+ ã§ã¯ `user&.name`ï¼ˆsafe navigation operatorï¼‰ãŒè¨€èªæ©Ÿèƒ½ã¨ã—ã¦å°å…¥ã•ã‚Œã¦ãŠã‚Šã€ç¾åœ¨ã¯ã“ã¡ã‚‰ãŒã‚ˆã‚Šæ¨å¥¨ã•ã‚Œã¾ã™ã€‚',
    },
    {
      id: 'as6',
      category: 'ActiveSupport core-ext',
      categoryKey: 'activesupport',
      before: `role == "admin" || role == "editor" || role == "viewer"`,
      correct: `role.in?(%w[admin editor viewer])`,
      choices: [
        { text: `role.in?(%w[admin editor viewer])`, correct: true },
        { text: `%w[admin editor viewer].any? { |r| r == role }`, correct: false },
        { text: `role.any?(%w[admin editor viewer])`, correct: false },
        { text: `role.one_of?("admin", "editor", "viewer")`, correct: false },
      ],
      explanation: '`in?` ã‚’ä½¿ã†ã¨è¤‡æ•°å€¤ã¨ã®æ¯”è¼ƒãŒä¸€è¡Œã§æ›¸ã‘ã¾ã™ã€‚å€¤ãŒå¢—ãˆã¦ã‚‚é…åˆ—ã«è¿½åŠ ã™ã‚‹ã ã‘ã§ã‚ˆãã€`||` ã§ç¹‹ãæ›¸ãæ–¹ã‚ˆã‚Šæ ¼æ®µã«ä¿å®ˆã—ã‚„ã™ããªã‚Šã¾ã™ã€‚',
    },
    {
      id: 'hash5',
      category: 'ActiveSupport core-ext',
      categoryKey: 'activesupport',
      before: `defaults.merge(config) do |_, old_val, new_val|
  old_val.is_a?(Hash) ? old_val.merge(new_val) : new_val
end`,
      correct: `defaults.deep_merge(config)`,
      choices: [
        { text: `defaults.deep_merge(config)`, correct: true },
        { text: `defaults.merge!(config)`, correct: false },
        { text: `defaults.recursive_merge(config)`, correct: false },
        { text: `defaults.nested_merge(config)`, correct: false },
      ],
      explanation: '`deep_merge` ã¯ ActiveSupport ãŒæä¾›ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã§ã€ãƒã‚¹ãƒˆã—ãŸ Hash ã‚’å†å¸°çš„ã«ãƒãƒ¼ã‚¸ã—ã¾ã™ã€‚é€šå¸¸ã® `merge` ã¯ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã®ã‚­ãƒ¼ã—ã‹ãƒãƒ¼ã‚¸ã—ã¾ã›ã‚“ãŒã€`deep_merge` ã¯ãƒã‚¹ãƒˆå…¨ä½“ã‚’ãƒãƒ¼ã‚¸ã—ã¾ã™ã€‚',
    },
  ],
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ã‚²ãƒ¼ãƒ çŠ¶æ…‹
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentCategory = null;
let currentQuestions  = [];
let currentIndex      = 0;
let score             = 0;
let answered          = false;
let categoryAnswers   = {};   // { activesupport: {correct:0, total:0}, ... }

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ç”»é¢åˆ‡æ›¿
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showScreen(name) {
  document.querySelectorAll('[id^="screen-"]').forEach(el => el.classList.add('hidden'));
  document.getElementById(`screen-${name}`).classList.remove('hidden');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ã‚¯ã‚¤ã‚ºé–‹å§‹
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startCategory(category) {
  currentCategory = category;
  currentQuestions = shuffle([...ALL_QUESTIONS[category]]);
  initQuiz();
}

function startAllCategories() {
  startCategory('activesupport');
}

function initQuiz() {
  currentIndex = 0;
  score = 0;
  categoryAnswers = {
    activesupport: { correct: 0, total: 0 },
  };
  showScreen('quiz');
  renderQuestion();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  å•é¡Œãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderQuestion() {
  const q = currentQuestions[currentIndex];
  answered = false;

  // ãƒ˜ãƒƒãƒ€ãƒ¼æ›´æ–°
  document.getElementById('q-current').textContent = currentIndex + 1;
  document.getElementById('q-total').textContent   = currentQuestions.length;
  document.getElementById('q-score').textContent   = score;

  // ã‚«ãƒ†ã‚´ãƒªãƒãƒƒã‚¸
  const badge = document.getElementById('q-category-badge');
  badge.textContent = q.category;

  // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼
  const pct = (currentIndex / currentQuestions.length) * 100;
  document.getElementById('progress-bar').style.width = `${pct}%`;

  // Before ã‚³ãƒ¼ãƒ‰
  const beforeEl = document.getElementById('q-before-code');
  beforeEl.removeAttribute('data-highlighted');
  beforeEl.textContent = q.before;
  hljs.highlightElement(beforeEl);

  // é¸æŠè‚¢
  const choicesEl = document.getElementById('q-choices');
  choicesEl.innerHTML = '';
  const shuffled = shuffle([...q.choices]);

  shuffled.forEach((choice, i) => {
    const btn = document.createElement('button');
    btn.className = [
      'choice-btn w-full text-left flex items-start gap-3 p-4 rounded-xl',
      'border border-gray-700 bg-gray-900/80 hover:bg-gray-800 hover:border-gray-500',
    ].join(' ');

    const label = document.createElement('span');
    label.className = 'text-gray-500 font-mono text-sm shrink-0 mt-0.5';
    label.textContent = `${String.fromCharCode(65 + i)})`;

    const codeWrap = document.createElement('pre');
    codeWrap.className = 'bg-transparent m-0 p-0 overflow-x-auto flex-1';
    const codeEl = document.createElement('code');
    codeEl.className = 'language-ruby text-sm !bg-transparent !p-0';
    codeEl.textContent = choice.text;
    codeWrap.appendChild(codeEl);

    btn.appendChild(label);
    btn.appendChild(codeWrap);
    btn.onclick = () => selectChoice(choice, btn, shuffled);
    choicesEl.appendChild(btn);
    hljs.highlightElement(codeEl);
  });

  // è§£èª¬ãƒ»æ¬¡ã¸ãƒœã‚¿ãƒ³ã‚’éš ã™
  document.getElementById('q-explanation').classList.add('hidden');
  document.getElementById('btn-next').classList.add('hidden');

  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  é¸æŠè‚¢ã‚¯ãƒªãƒƒã‚¯
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selectChoice(choice, clickedBtn, allChoices) {
  if (answered) return;
  answered = true;

  const q = currentQuestions[currentIndex];
  const allBtns = document.querySelectorAll('.choice-btn');

  allBtns.forEach(b => { b.disabled = true; });

  // æ­£è§£ãƒœã‚¿ãƒ³ã‚’ã‚°ãƒªãƒ¼ãƒ³ã«
  allBtns.forEach((b, i) => {
    if (allChoices[i].correct) {
      b.classList.remove('border-gray-700', 'bg-gray-900/80');
      b.classList.add('border-green-500', 'bg-green-900/40', 'correct-glow');
    }
  });

  if (choice.correct) {
    score++;
    document.getElementById('q-score').textContent = score;
    const scoreEl = document.getElementById('q-score');
    scoreEl.classList.remove('score-pulse');
    void scoreEl.offsetWidth;
    scoreEl.classList.add('score-pulse');
  } else {
    // é¸ã‚“ã ãƒœã‚¿ãƒ³ã‚’ãƒ¬ãƒƒãƒ‰ã«
    clickedBtn.classList.remove('border-gray-700', 'bg-gray-900/80');
    clickedBtn.classList.add('border-red-500', 'bg-red-900/40', 'wrong-glow');
    clickedBtn.classList.add('shake');
  }

  // ã‚«ãƒ†ã‚´ãƒªã‚¹ã‚³ã‚¢è¨˜éŒ²
  const cat = q.categoryKey;
  categoryAnswers[cat].total++;
  if (choice.correct) categoryAnswers[cat].correct++;

  // è§£èª¬è¡¨ç¤º
  const afterEl = document.getElementById('q-after-code');
  afterEl.removeAttribute('data-highlighted');
  afterEl.textContent = q.correct;
  hljs.highlightElement(afterEl);

  document.getElementById('q-explanation-text').textContent = q.explanation;

  // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒªãƒ³ã‚¯
  const docLink  = document.getElementById('q-doc-link');
  const docLabel = document.getElementById('q-doc-label');
  const doc = DOC_URLS[q.id];
  if (doc) {
    docLink.href = doc.url;
    docLabel.textContent = doc.label;
    docLink.classList.remove('hidden');
  } else {
    docLink.classList.add('hidden');
  }

  document.getElementById('q-explanation').classList.remove('hidden');
  document.getElementById('btn-next').classList.remove('hidden');

  setTimeout(() => {
    document.getElementById('q-explanation').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }, 150);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  æ¬¡ã®å•é¡Œ
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function nextQuestion() {
  currentIndex++;
  if (currentIndex >= currentQuestions.length) {
    showResult();
  } else {
    renderQuestion();
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ãƒªã‚¶ãƒ«ãƒˆç”»é¢
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showResult() {
  showScreen('result');
  const total = currentQuestions.length;
  document.getElementById('result-score').textContent = score;
  document.getElementById('result-total').textContent  = total;

  const pct = score / total;
  let emoji, msg;
  if (pct >= 0.9) { emoji = 'ğŸ†'; msg = 'å®Œç’§ï¼Rails ãƒã‚¹ã‚¿ãƒ¼ã§ã™ã­ï¼'; }
  else if (pct >= 0.7) { emoji = 'ğŸ‰'; msg = 'ç´ æ™´ã‚‰ã—ã„ï¼Rails ã®æ›¸ãæ–¹ã‚’ã‚ˆãç†è§£ã—ã¦ã„ã¾ã™ï¼'; }
  else if (pct >= 0.5) { emoji = 'ğŸ‘'; msg = 'è‰¯ã„èª¿å­ï¼ã‚‚ã†å°‘ã—ç·´ç¿’ã™ã‚Œã°å®Œç’§ã§ã™ï¼'; }
  else { emoji = 'ğŸ“š'; msg = 'Rails ã®é­”æ³•ã‚’ã‚‚ã£ã¨å­¦ã‚“ã§ã¿ã¾ã—ã‚‡ã†ï¼'; }

  document.getElementById('result-emoji').textContent   = emoji;
  document.getElementById('result-message').textContent = msg;

  // æ˜Ÿ
  const stars = Math.round(pct * 5);
  document.getElementById('result-stars').textContent = 'â­'.repeat(stars) + 'â˜†'.repeat(5 - stars);

  // ã‚«ãƒ†ã‚´ãƒªåˆ¥
  const rows = document.getElementById('breakdown-rows');
  const catInfo = {
    activesupport: { label: 'âš¡ ActiveSupport', color: 'indigo' },
  };
  rows.innerHTML = Object.entries(categoryAnswers).map(([cat, {correct, total: t}]) => {
    if (t === 0) return '';
    const c = catInfo[cat];
    const catPct = t > 0 ? Math.round((correct / t) * 100) : 0;
    return `
      <div class="flex items-center justify-between py-3 border-b border-gray-800 last:border-0">
        <span class="text-gray-300">${c.label}</span>
        <div class="flex items-center gap-3">
          <div class="w-24 bg-gray-800 rounded-full h-1.5">
            <div class="h-1.5 rounded-full bg-${c.color}-500" style="width:${catPct}%"></div>
          </div>
          <span class="text-yellow-400 font-bold tabular-nums w-12 text-right">${correct} / ${t}</span>
        </div>
      </div>`;
  }).join('');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function goHome() { showScreen('home'); }

function retryCurrentCategory() {
  startCategory('activesupport');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ã‚°ãƒ­ãƒ¼ãƒãƒ«å…¬é–‹
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.goHome               = goHome;
window.startAllCategories   = startAllCategories;
window.nextQuestion         = nextQuestion;
window.retryCurrentCategory = retryCurrentCategory;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  ã‚«ãƒ†ã‚´ãƒªã‚«ãƒ¼ãƒ‰
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.category-card').forEach(card => {
  card.addEventListener('click', () => startCategory(card.dataset.category));
});

</script>
</body>
</html>
